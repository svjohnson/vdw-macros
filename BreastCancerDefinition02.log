1                                                          The SAS System                          11:28 Wednesday, January 14, 2009

NOTE: Unable to open SASUSER.REGSTRY. WORK.REGSTRY will be opened instead.
NOTE: All registry changes will be lost at the end of the session.

WARNING: The Base Product product with which Session Manager is associated 
         will be expiring soon, and is currently in warning mode to indicate 
         this upcoming expiration. Most typically this warning period runs 
         for 45 days. Please run PROC SETINIT to obtain more information on 
         your warning period.
WARNING: The Base Product product with which TKSRV    is associated will be 
         expiring soon, and is currently in warning mode to indicate this 
         upcoming expiration. Most typically this warning period runs for 45 
         days. Please run PROC SETINIT to obtain more information on your 
         warning period.
WARNING: The Base Product product with which DOS Monitor is associated will 
         be expiring soon, and is currently in warning mode to indicate this 
         upcoming expiration. Most typically this warning period runs for 45 
         days. Please run PROC SETINIT to obtain more information on your 
         warning period.
WARNING: The Base Product product with which Program 
         "\\groups\data\CTRHS\Crn\S D R 
         C\VDW\Macros\BreastCancerDefinition02.sas" is associated will be 
         expiring soon, and is currently in warning mode to indicate this 
         upcoming expiration. Most typically this warning period runs for 45 
         days. Please run PROC SETINIT to obtain more information on your 
         warning period.
NOTE: Copyright (c) 2002-2003 by SAS Institute Inc., Cary, NC, USA. 
NOTE: SAS (r) 9.1 (TS1M3)
      Licensed to GROUP HEALTH COOPERATIVE OF PUGET SOUND, Site 0009688001.
NOTE: This session is executing on the XP_PRO  platform.



NOTE: SAS 9.1.3 Service Pack 4

WARNING: Your system is scheduled to expire on February 12, 2009, which is 29 days from now.  
         Please contact your SAS Software Representative to obtain your updated SETINIT 
         information.  The SAS System will no longer function on or after that date.
NOTE: SAS initialization used:
      real time           6.14 seconds
      cpu time            0.68 seconds
      
WARNING: The Base Product product with which DATASTEP is associated will be expiring soon, and 
         is currently in warning mode to indicate this upcoming expiration. Most typically this 
         warning period runs for 45 days. Please run PROC SETINIT to obtain more information on 
         your warning period.
WARNING: The Base Product product with which DATASTEP is associated will be expiring soon, and 
         is currently in warning mode to indicate this upcoming expiration. Most typically this 
         warning period runs for 45 days. Please run PROC SETINIT to obtain more information on 
         your warning period.
1          %macro BreastCancerDefinition02(StartDt = 01Jan1997
2                                        , EndDt = 31Dec2003
3                                        , OutSet = brca
4                                        , OutMultFirsts =
2                                        The SAS System        11:28 Wednesday, January 14, 2009

5                                        ) ;
6             /*
7              Adapted from 01, for Pharmacovigilance.  Differences:
8                01 includes DCIS (but not LCIS).  This is invasive tumors only.
9                Pulls more variables directly (still creating composites as necessary to create
9        !  a one-rec-per-woman outset).
10               Not so much printing (but optional output dset).
11               More warnings.
12            */
13         
14           %local female ;
15           %let   female = 2 ;
16         
17           proc sql number ;
18             * We take these over all time since the file is small and we want to be ;
19             * able to call the resulting cases "incident" insofar as we can ;
20             create table _AllBreastTumors as
21             select mrn
22                 , DxDate
23                 , StageGen
24                 , StageAJ
25                 , DtMrk1 as ERMarker
26                 , DtMrk2 as PRMarker
27                 , coalesce(dchm_sum, dchm_fac) as tumor_chemo
28                 , dt_chemo
29                 , r_n_chemo
30             from  &_vdw_tumor
31             where DxDate le "&EndDt"d                  AND
32                   Gender = "&female"                   AND
33                   ICDOSite between 'C500' and 'C509'   AND
34                   Morph NOT between '9590' and '9979'  AND
35                   behav in ('3', '6', '9')
36             ;
37         
38           * REMOVE ME ROY!!! ;
39           quit ;
40         
41           proc freq data = _allbreasttumors ;
42             tables PRMarker tumor_chemo r_n_chemo / missing ;
43           run ;
44         
45           proc sql ;
46           * END REMOVE ME ROY!!! ;
47         
48             * Check desired date limits against observed, and warn as necessary. ;
49             select  min(dxdate) as first_tumor   format = yymmddn8. label = "First observed
49       ! breast tumor (over all time)"
50                   , max(dxdate) as last_tumor    format = yymmddn8. label = "Last observed
50       ! breast tumor (over all time)"
51                   , "&StartDt"d as desired_first format = yymmddn8.
52                   , "&EndDt"d   as desired_last  format = yymmddn8.
53             into :first_tumor, :last_tumor, :desired_first, :desired_last
54             from _AllBreastTumors
3                                        The SAS System        11:28 Wednesday, January 14, 2009

55             ;
56         
57             %if &desired_first < &first_tumor %then %do i = 1 %to 10 ;
58               %put WARNING: NO BREAST TUMORS FOUND PRIOR TO &STARTDT (EARLIEST IS
58       ! &FIRST_TUMOR)--EARLY TUMORS MAY NOT BE AS "INCIDENT" AS LATER ONES!!! ;
59             %end ;
60         
61             %if &desired_last > &last_tumor %then %do i = 1 %to 10 ;
62               %put WARNING: NO BREAST TUMORS FOUND AFTER &LAST_TUMOR.--THE &_TUMORDATA FILE
62       ! IS NOT EXTENSIVE ENOUGH TO MEET THIS REQUEST!!! ;
63             %end ;
64         
65             * Grab all tumors from each womans first dxdate. ;
66             create table _FirstBTs as
67             select DISTINCT b.*
68             from  _AllBreastTumors as b
69               INNER JOIN
70                   (select MRN, min(DxDate) as FirstBTDate
71                     from _AllBreastTumors
72                     group by MRN
73                     having min(DxDate) between "&StartDt"d and "&EndDt"d) as b2
74             on    b.MRN = b2.MRN AND
75                   b.DxDate = b2.FirstBTDate
76             order by mrn, ERMarker ;
77         
78             drop table _AllBreastTumors ;
79         
80             * Who had > 1 breast tumor discovered on the day of their first tumor? ;
81             create table _multiple_firsts as
82             select *
83             from  _FirstBTs
84             where MRN in (select _FirstBTs.MRN
85                           from _FirstBTs
86                           group by _FirstBTs.MRN
87                           having count(*) > 1)
88             ;
89         
90             %if &SQLOBS > 0 %then %do ;
91               %do i = 1 %to 5 ;
92                 %PUT BCD2 NOTE: There may be as many as %eval(&SQLOBS/2) people with > 1
92       ! tumor dignosed on the same day, each with different receptor statuses or stages. ;
93                 %PUT BCD2 NOTE: The macro will output composite records for each such person
93       ! e.g., w/max(stage), ER+ if any are +, etc.. ;
94               %end ;
95               %if %length(&OutMultFirsts) > 0 %then %do ;
96                 create table &OutMultFirsts as
97                 select *
98                 from _multiple_firsts
99                 ;
100        
101                %put BCD2 NOTE: The multiple-first-tumor records have been written out to
101      ! &OutMultFirsts ;
102                %put BCD2 NOTE: The multiple-first-tumor records have been written out to
4                                        The SAS System        11:28 Wednesday, January 14, 2009

102      ! &OutMultFirsts ;
103                %put BCD2 NOTE: The multiple-first-tumor records have been written out to
103      ! &OutMultFirsts ;
104                %put BCD2 NOTE: The multiple-first-tumor records have been written out to
104      ! &OutMultFirsts ;
105              %end ;
106        
107            %end ;
108        
109            * Some women will have > 1 breast tumor dxd on the same day, each with ;
110            * different stages and/or receptor statuses.  We want to call the ;
111            * receptor status positive if any tumor is positive, and we want to ;
112            * take the greatest stage, etc. ;
113        
114            create table &OutSet as
115            select mrn
116                  , dxdate
117                  , min(case ERMarker
118                           when '0' then 10
119                           else input(ERMarker, 2.0)
120                        end) as ERMarker
121                  , max(case lowcase(StageGen)
122                           when '9' then -1
123                           when 'b' then -2
124                           else input(StageGen, 2.0)
125                        end) as StageGen
126                  , max(case lowcase(StageAJ)
127                           when '' then -1
128                           when 'unk' then -1
129                           when '2a' then 2
130                           when '2b' then 2.5
131                           when '3a' then 3
132                           when '3b' then 3.5
133                           else input(StageAJ, 2.0)
134                        end) as StageAJ
135            from _FirstBTs
136            group by mrn, dxdate ;
137          quit ;
138        
139        %mend BreastCancerDefinition02 ;
140        

NOTE: SAS Institute Inc., SAS Campus Drive, Cary, NC USA 27513-2414
NOTE: The SAS System used:
      real time           6.39 seconds
      cpu time            0.76 seconds
      
