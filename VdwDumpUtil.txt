%macro VdwDumpUtil(datset,outdsd,outdsp,outrx,startdt,enddt);
*******************************************************************;
* print hosp and ambulatory information on a group of people
* Purpose is to try understand what is happening
* input dataset must contain
*     chsid, studyid
*   datset is input dataset
*   outds is output dataset
*        d is diagnoses
         p is procedures
         rx is rx
*   startdt is the start of the time period of interest
*   enddt is the end of the time period of interest
*******************************************************************;
libname q '\\ctrhs-dbserver\scratch\sasgene';

%include '\\GROUPS\DATA\CTRHS\Crn\S D R C\VDW\Macros\CRN_VDW_MACROS.sas';

%GetDxForPeople(&datset     /* The name of a dataset containing the people whose diagnoses you want. */
               , StartDt    /* The date on which you want to start collecting diagnoses. */
               , EndDt      /* The date on which you want to stop collecting diagnoses. */
               , &outdsd    /* The name of the output dataset containing the diagnoses. */) ;

%GetPxForPeople(&datset     /* The name of a dataset containing the people whose procedures you want. */
               , StartDt    /* The date on which you want to start collecting procedures. */
               , EndDt      /* The date on which you want to stop collecting procedures. */
               , &outdsp    /* The name of the output dataset containing the procedures. */) ;

* do the diagnoses
*************************;
data util2(keep=chsid thedate dxnew datsour);
  set hcfa_x(in=inhcfa keep=chsid diagcode servfmdt rename=(servfmdt=thedate diagcode=diagcd1))
      ub92_x(in=inu keep=chsid diagcd1-diagcd5 admdate rename=(admdate=thedate))
      arpa_x(in=ina keep=chsid diagcd1-diagcd10 vistdate rename=(vistdate=thedate))
      hosp_x(in=inhosp keep=chsid diagcd1-diagcd10 admtdate rename=(admtdate=thedate))
      ;
  length datsour $8;
  if inhcfa then datsour='hcfa1500';
  else if inu then datsour = 'ub92';
  else if ina then datsour = 'GH Vis';
  else if inhosp then datsour = 'Hosp';

  array dx{10} diagcd1-diagcd10;
  do i = 1 to 10;
    if dx{i} ^= '      ' then do;
        dxnew = dx{i};
        output;
        end;
  end;
  run;

* get rid of dup dx the same day;
proc sort data=util2 nodupkey;
by chsid thedate dxnew;
run;

proc sort data=util2;
by chsid thedate dxnew datsour;
run;

*proc print data=util2(obs=20);
run;

libname base '\\ctrhs-dbserver\Warehouse\Sasdata\baseline';
proc sql;
  create table util3 as
  select distinct util2.*, diagdesc, seer.dxdate, seer.studyid
  from base.diagcd, util2, &datset. as seer
  where diagcd.diagcd = util2.dxnew and
        seer.chsid=util2.chsid
  order by chsid, thedate, diagcd;
  quit;

data &outdsd.;
  set util3;
*  retain missid 9000;
*  by chsid;
*  if first.chsid then missid+1;
  ;
run;
proc sort;
by studyid thedate;
run;


* do the procedures (look at the contents and change to the procedure names;
*****************************;

data proc2(keep=chsid thedate procnew datsour);
  length datsour $8 proccd1-proccd15 $7;
  set hcfa_x(in=inhcfa keep=chsid servitem servfmdt rename=(servfmdt=thedate servitem=proccd1))
      ub92_x(in=inu keep=chsid srgproc1 srgproc2 admdate rename=(admdate=thedate srgproc1=proccd1
                                                                 srgproc2=proccd2))
      arpa_x(in=ina keep=chsid proccd1-proccd10 vistdate rename=(vistdate=thedate))
      hosp_x(in=inhosp keep=chsid proccd1-proccd15 admtdate rename=(admtdate=thedate))
      ;

  if inhcfa then datsour='hcfa1500';
  else if inu then datsour = 'ub92';
  else if ina then datsour = 'GH Vis';
  else if inhosp then datsour = 'Hosp';

  array pr{15} proccd1-proccd15;
  do i = 1 to 15;
    if pr{i} ^= '      ' then do;
        procnew = pr{i};
        output;
        end;
  end;
  * get rid of dup dx the same day;
proc sort data=proc2 nodupkey;
by chsid thedate procnew;
run;

proc sort data=proc2;
by chsid thedate procnew datsour;
run;

libname base '\\ctrhs-dbserver\Warehouse\Sasdata\baseline';
proc sql;
  create table procicd as
  select distinct proc2.*, icd9des as procdesc, ds.dxdate, ds.studyid
  from base.icd9, proc2, &datset. as ds
  where icd9.icd9cde = proc2.procnew and
        ds.chsid=proc2.chsid and
        proc2.datsour in('Hosp','UB92')
  order by chsid, thedate, procnew;
  quit;
proc sql;
  create table proccpt as
  select distinct proc2.*, cpt4des as procdesc, ds.dxdate, ds.studyid
  from base.cpt4, proc2, &datset. as ds
  where cpt4.cpt4cde = proc2.procnew and
        ds.chsid=proc2.chsid and
        proc2.datsour in('GH Vis','hcfa1500')
  order by chsid, thedate, procnew;
  quit;
data &outdsp.;
  set procicd proccpt;
*  retain missid 9000;
*  by chsid;
*  if first.chsid then missid+1;
  ;
run;
proc sort;
by studyid thedate;
run;


* do the drugs;
****************;
%plrxcons(_outrx,&datset,chsid,&startdt.,&enddt.)

* get the drugname etc.;
libname rx '\\ctrhs-dbserver\Warehouse\Sasdata\RX';
proc sql;
  create table _outrx1 as
  select _outrx.*, drugpro, drugform, ndccode, ndccde11
  from _outrx left join rx.drugs
  on _outrx.drugno = drugs.drugno
  order by chsid, rxdate
  ;
proc sql;
  create table &outrx. as
  select _outrx1.*, studyid
  from _outrx1, &datset. as ds
  where _outrx1.chsid = ds.chsid
  ;

%mend;

